<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Student Face Attendance (Flask)</title>

  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; background:#f6f7fb; }

    header {
      padding: 14px 18px;
      background: #111;
      color: #fff;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .wrap {
      display: flex;
      gap: 16px;
      padding: 16px;
      min-height: calc(100vh - 52px);
    }

    /* 50/50 split */
    .left, .right {
      flex: 1;
      min-width: 360px;
    }

    .card {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    }

    .card h2 {
      margin: 0 0 12px 0;
      font-size: 16px;
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    input[type="text"], input[type="email"], input[type="password"] {
      padding: 10px;
      border: 1px solid #d9d9d9;
      border-radius: 10px;
      width: 200px;
      outline: none;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus { border-color: #2563eb; }

    input[type="file"] {
      padding: 8px;
      border: 1px dashed #cfcfcf;
      border-radius: 10px;
      background: #fafafa;
      width: 260px;
    }

    button {
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }

    button.primary { background: #2563eb; color: #fff; }
    button.danger { background: #dc2626; color: #fff; }
    button.gray { background: #111827; color: #fff; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .preview {
      width: 100%;
      max-height: 520px;
      border-radius: 12px;
      border: 1px solid #e6e6e6;
      background: #fff;
      object-fit: contain;
    }

    .note { color: #555; margin-top: 8px; font-size: 13px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; font-size: 14px; }
    th { background: #fafafa; position: sticky; top: 0; z-index: 1; }

    .thumb {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid #e6e6e6;
      background: #fff;
    }

    .status { font-weight: bold; }
    .Present { color: #16a34a; }
    .Absent { color: #dc2626; }
    .Invalid { color: #6b7280; }

    .flash {
      background:#fff7ed;
      border:1px solid #fed7aa;
      color:#9a3412;
      padding:10px;
      border-radius:12px;
      margin-top:12px;
      display:none;
      white-space: pre-line;
    }

    .actionsBar {
      display:flex;
      gap:10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    /* Account card (top of right column) */
    .auth-card { padding: 12px; margin-bottom: 12px; border-radius: 12px; background: #fff; border: 1px solid #e6e6e6; }
    .auth-card label { display: block; font-size: 13px; color: #333; margin-bottom: 4px; }
    .auth-card .field { margin-bottom: 8px; text-align: left; }
    .auth-actions { margin-top: 8px; display: flex; gap: 8px; }

    /* Responsive */
    @media (max-width: 900px) {
      .wrap { flex-direction: column; }
      .left, .right { min-width: 0; }
      input[type="file"] { width: 100%; }
      input[type="text"], input[type="email"], input[type="password"] { width: 100%; }
    }
  </style>
</head>

<body>
  <header>
    <h1 style="margin:0; font-size:18px;">Student Face Attendance (YuNet + SFace)</h1>
  </header>

  <div class="wrap">

    <!-- LEFT -->
    <div class="left">
      <div class="card">
        <h2>1) Upload Group Image</h2>

        <form id="groupForm" class="row">
          <input type="file" id="groupFile" name="group_image" accept=".jpg,.jpeg,.png,.bmp,.tif,.tiff" />
          <button class="primary" type="submit">Upload Group</button>
        </form>

        <div class="note">Preview (after upload / run):</div>
        <img id="groupPreview" class="preview" alt="Group Preview" style="margin-top:10px;" />

        <div id="statusBox" class="flash"></div>

        <div class="actionsBar">
          <button class="gray" id="runBtn" type="button" onclick="runRecognition()">Run Recognition</button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
     <div class="right">
      <div class="auth-card">
        <h3 style="margin:0 0 8px 0; font-size:15px;">Account</h3>
        <div class="field">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" placeholder="Email" />
        </div>
        <div class="field">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" placeholder="Password" />
        </div>
        <div class="auth-actions">
          <button id="loginBtn" class="primary" type="button">Login</button>
          <button id="logoutBtn" class="danger" type="button">Logout</button>
        </div>
      </div>

      <div class="card">
        <h2>2) Add Student</h2>
                
        <form id="studentForm">
          <div class="row">
            <input type="text" id="name" name="name" placeholder="Student Name" />
            <input type="text" id="roll" name="roll" placeholder="Roll Number" />
            <input id="studentFile" name="student_image" type="file">

            <button class="primary" type="submit">Add Student</button>
          </div>
        </form>

        <div class="note">Saved permanently in <b>student_db/images</b>.</div>
      </div>

      <div class="card">
        <h2>3) Saved Students</h2>
        <table>
          <thead>
            <tr>
              <th style="width:60px;">Photo</th>
              <th>Name</th>
              <th>Roll</th>
              <th>Saved Image</th>
              <th>Status</th>
              <th style="width:120px;">Action</th>
            </tr>
          </thead>
          <tbody id="studentsBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    function showStatus(msg) {
      const box = document.getElementById("statusBox");
      box.style.display = "block";
      box.innerText = msg;
      console.log("[INFO]", msg);
    }

    function cacheBust(url) {
      const t = Date.now();
      return url.includes("?") ? `${url}&t=${t}` : `${url}?t=${t}`;
    }

    async function loadState() {
      const res = await fetch("/api/state");
      const data = await res.json();

      const img = document.getElementById("groupPreview");
      if (data.annotated_exists) {
        img.src = cacheBust("/static/results/annotated.png");
      } else if (data.group_exists) {
        img.src = cacheBust("/group_image");
      } else {
        img.removeAttribute("src");
      }

      const tbody = document.getElementById("studentsBody");
      tbody.innerHTML = "";

      for (const st of data.students) {
        const tr = document.createElement("tr");

        const td0 = document.createElement("td");
        const im = document.createElement("img");
        im.className = "thumb";
        if (st.img_file) {
          im.src = cacheBust(`/student_image/${encodeURIComponent(st.img_file)}`);
        }
        td0.appendChild(im);

        const td1 = document.createElement("td");
        td1.innerText = st.name || "";

        const td2 = document.createElement("td");
        td2.innerText = st.roll || "";

        const td3 = document.createElement("td");
        td3.innerText = st.img_file || "";

        const td4 = document.createElement("td");
        td4.className = `status ${st.status}`;
        td4.innerText = st.status || "Saved";

        const td5 = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.className = "danger";
        delBtn.type = "button";
        delBtn.innerText = "Remove";
        delBtn.onclick = () => deleteStudent(st.roll);
        td5.appendChild(delBtn);

        tr.appendChild(td0);
        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tr.appendChild(td4);
        tr.appendChild(td5);

        tbody.appendChild(tr);
      }

      document.getElementById("runBtn").disabled = !(data.group_exists && data.students.length > 0);

      if (data.message) showStatus(data.message);
    }

    // Upload group
    document.getElementById("groupForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const f = document.getElementById("groupFile").files[0];
      if (!f) return showStatus("Please select a group image.");

      const fd = new FormData();
      fd.append("group_image", f);

      showStatus("Uploading group...");
      const res = await fetch("/upload_group", { method: "POST", body: fd });
      const data = await res.json();
      showStatus(data.message || "Done");
      await loadState();
    });

    // Add student
    document.getElementById("studentForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const roll = document.getElementById("roll").value.trim();

      // NEW
      // const email = document.getElementById("email").value.trim();
      // const password = document.getElementById("password").value.trim();

      const f = document.getElementById("studentFile").files[0];

      if (!name || !roll) return showStatus("Name and Roll are required.");
      // if (!email || !password) return showStatus("Email and Password are required.");
      if (!f) return showStatus("Please select a student image.");

      const fd = new FormData();
      fd.append("name", name);
      fd.append("roll", roll);

      // NEW
      fd.append("email", email);
      fd.append("password", password);

      fd.append("student_image", f);

      showStatus("Saving student...");
      const res = await fetch("/add_student", { method: "POST", body: fd });
      const data = await res.json();

      showStatus(data.message || "Saved");

      document.getElementById("name").value = "";
      document.getElementById("roll").value = "";

      // NEW
      document.getElementById("email").value = "";
      document.getElementById("password").value = "";

      document.getElementById("studentFile").value = "";

      await loadState();
    });

    async function deleteStudent(roll) {
      if (!roll) return;
      showStatus("Removing student...");
      const res = await fetch(`/delete_student/${encodeURIComponent(roll)}`, { method: "POST" });
      const data = await res.json();
      showStatus(data.message || "Removed");
      await loadState();
    }

    async function runRecognition() {
      showStatus("Running recognition...");
      const res = await fetch("/run", { method: "POST" });
      const data = await res.json();
      showStatus(data.message || "Done");
      await loadState();
    }

    // Login handler for Account card
    document.getElementById("loginBtn").addEventListener("click", async () => {
    
     
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) return showStatus("Email and Password are required.");
      showStatus("Logging in...");
      try {
        const fd = new FormData();
        fd.append('email', email);
        fd.append('password', password);
        const res = await fetch("/login", { method: "POST", body: fd });
        const data = await res.json();
        showStatus(data.message || "Login response received.");
      } catch (err) {
        console.error(err);
        showStatus("Login failed (network error).");
      }
    });

    // Logout handler for Account card
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      showStatus("Logging out...");
      try {
        const res = await fetch("/logout", { method: "POST" });
        const data = await res.json();
        showStatus(data.message || "Logged out.");
        // Optionally clear inputs on logout
        document.getElementById("email").value = "";
        document.getElementById("password").value = "";
      } catch (err) {
        console.error(err);
        showStatus("Logout failed (network error).");
      }
    });

    loadState();
  </script>
</body>
</html>
